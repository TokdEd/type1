<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>人潮雷達原型 | Azure Maps</title>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: Arial;
      overflow: hidden;
    }
    #map {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0; left: 0;
      z-index: 0;
    }
    #radar-fab {
      position: fixed;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      background: rgba(255,255,255,0.25);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.18);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
    }
    #radar-fab:hover {
      box-shadow: 0 12px 40px 0 rgba(31,38,135,0.45);
      background: rgba(255,255,255,0.35);
    }
    
    /* 時間軸控制器 */
    .time-control {
      position: fixed;
      bottom: 4vh;
      transform: translateY(-50%);
      z-index: 19;
      display: flex;
      align-items: center;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .time-control.left {
      left: calc(50% - 200px);
    }
    
    .time-control.right {
      right: calc(50% - 200px);
    }
    
    .time-slider-container {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 12px 20px;
      box-shadow: 0 6px 24px rgba(31,38,135,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }
    
    .time-label {
      color: #222;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255,255,255,0.3);
      letter-spacing: 0.5px;
    }
    
    .time-slider {
      width: 100px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      position: relative;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .time-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .time-display {
      color: #333;
      font-size: 12px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(255,255,255,0.4);
      min-width: 50px;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .time-control.left {
        left: 10px;
      }
      .time-control.right {
        right: 10px;
      }
      .time-slider-container {
        min-width: 100px;
        padding: 10px 16px;
      }
      .time-slider {
        width: 80px;
      }
    }
    #glass-panel {
      position: fixed;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%) scale(0.98);
      width: 94vw;
      max-width: 480px;
      min-height: 60vh;
      max-height: 88vh;
      background: rgba(255,255,255,0.18);
      box-shadow: 0 12px 48px 0 rgba(31,38,135,0.45);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 32px;
      border: 1.5px solid rgba(255,255,255,0.18);
      z-index: 30;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      transition: transform 0.35s cubic-bezier(.4,1.6,.4,1), opacity 0.3s;
      opacity: 0;
      pointer-events: none;
      padding: 32px 18px 20px 18px;
      box-sizing: border-box;
    }
    #glass-panel.open {
      transform: translateX(-50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 600px) {
      #glass-panel {
        width: 98vw;
        max-width: 99vw;
        min-height: 80vh;
        left: 50%;
        bottom: 0;
        padding: 24px 4vw 16px 4vw;
      }
      #chat-history {
        max-height: 400px;
      }
      #clear-chat {
        left: 60px; /* 在小螢幕上稍微調整位置 */
        width: 28px;
        height: 28px;
        font-size: 1em;
      }
    }
    #close-panel {
      position: absolute;
      top: 18px;
      right: 24px;
      background: rgba(0,0,0,0.08);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2em;
      color: #333;
      cursor: pointer;
      z-index: 40;
      transition: background 0.2s;
    }
    #close-panel:hover {
      background: rgba(0,0,0,0.18);
    }
    #settings-panel {
      position: absolute;
      top: 18px;
      left: 24px;
      background: rgba(0,0,0,0.08);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2em;
      color: #333;
      cursor: pointer;
      z-index: 40;
      transition: background 0.2s;
    }
    #settings-panel:hover {
      background: rgba(0,0,0,0.18);
    }
    #clear-chat {
      position: absolute;
      top: 18px;
      left: 66px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,69,58,0.3);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.1em;
      color: #ff6b6b;
      cursor: pointer;
      z-index: 40;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      box-shadow: 0 4px 16px rgba(255,69,58,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clear-chat:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,69,58,0.5);
      color: #ff453a;
      transform: scale(1.08) translateY(-1px);
      box-shadow: 0 6px 20px rgba(255,69,58,0.3);
    }
    #clear-chat:active {
      transform: scale(0.96) translateY(0px);
      box-shadow: 0 2px 8px rgba(255,69,58,0.25);
      background: rgba(255,255,255,0.2);
    }
    #settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #settings-modal.open {
      opacity: 1;
      pointer-events: auto;
    }
    #settings-form {
      background: rgba(255,255,255,0.25);
      box-shadow: 0 12px 48px 0 rgba(31,38,135,0.45);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1.5px solid rgba(255,255,255,0.18);
      padding: 32px;
      max-width: 480px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
    }
    #settings-form h3 {
      margin: 0 0 20px 0;
      color: #222;
      font-size: 1.3em;
      text-align: center;
    }
    #settings-form label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    #custom-prompt {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border: 1px solid rgba(200,200,200,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.25);
      color: #222;
      font-size: 1em;
      resize: vertical;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      outline: none;
      transition: border 0.2s;
      box-sizing: border-box;
    }
    #custom-prompt:focus {
      border: 1.5px solid #0078d4;
      background: rgba(255,255,255,0.35);
    }
    .settings-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .settings-btn {
      flex: 1;
      padding: 12px 0;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .settings-btn.save {
      background: rgba(0,120,212,0.25);
      color: #fff;
    }
    .settings-btn.save:hover {
      background: rgba(0,95,163,0.35);
    }
    .settings-btn.cancel {
      background: rgba(128,128,128,0.25);
      color: #fff;
    }
    .settings-btn.cancel:hover {
      background: rgba(96,96,96,0.35);
    }
    #prompt-input {
      width: 95%;
      max-width: 520px;
      padding: 14px 18px;
      border: 1px solid rgba(200,200,200,0.18);
      border-radius: 16px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.18);
      color: #222;
      font-size: 1.08em;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      outline: none;
      transition: border 0.2s;
    }
    #prompt-input:focus {
      border: 1.5px solid #0078d4;
      background: rgba(255,255,255,0.28);
    }
    #ask-btn {
      width: 95%;
      max-width: 520px;
      padding: 14px 0;
      background: rgba(0,120,212,0.22);
      color: #fff;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1.08em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: background 0.2s;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    #ask-btn:hover {
      background: rgba(0,95,163,0.32);
    }
    #advice-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 8px;
      color: #222;
      text-shadow: 0 1px 2px rgba(255,255,255,0.2);
    }
    #advice-content {
      font-size: 1em;
      color: #333;
      margin-bottom: 8px;
      text-align: center;
      word-break: break-all;
    }
    #chat-history {
      width: 100%;
      max-width: 520px;
      min-height: 180px;
      max-height: 350px;
      overflow-y: auto;
      background: rgba(255,255,255,0.13);
      border-radius: 18px;
      margin-bottom: 10px;
      padding: 16px 12px 16px 12px;
      box-sizing: border-box;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      font-size: 1em;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .message {
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 90%;
      word-break: break-word;
      margin-bottom: 2px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .message.user {
      align-self: flex-end;
      background: rgba(0,120,212,0.18);
      color: #1a2a3a;
    }
    .message.ai {
      align-self: flex-start;
      background: rgba(255,255,255,0.7);
      color: #222;
    }
    /* 地點資訊卡樣式 */
    .location-info-card {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      width: 90vw;
      max-width: 400px;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1.5px solid rgba(255,255,255,0.18);
      box-shadow: 0 12px 48px rgba(31,38,135,0.4);
      padding: 24px;
      z-index: 25;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .location-info-card.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1);
    }
    
    .info-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .info-card-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #222;
      text-shadow: 0 1px 2px rgba(255,255,255,0.3);
      margin: 0;
    }
    
    .info-card-close {
      background: rgba(0,0,0,0.1);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1em;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .info-card-close:hover {
      background: rgba(0,0,0,0.2);
      color: #333;
    }
    
    .info-card-content {
      display: grid;
      gap: 12px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .info-label {
      font-size: 0.9em;
      color: #555;
      font-weight: 500;
    }
    
    .info-value {
      font-size: 1em;
      font-weight: 600;
      color: #222;
    }
    
    .info-value.crowd-level {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.85em;
      text-shadow: none;
    }
    
    .crowd-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .crowd-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 8px currentColor;
    }
    
    @media (max-width: 600px) {
      .location-info-card {
        width: 95vw;
        bottom: 100px;
        padding: 20px;
      }
      .info-card-title {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- 地點資訊卡 -->
  <div id="location-info-card" class="location-info-card">
    <div class="info-card-header">
      <h3 id="info-card-title" class="info-card-title">地點名稱</h3>
      <button id="info-card-close" class="info-card-close">✕</button>
    </div>
    <div class="info-card-content">
      <div class="info-item">
        <span class="info-label">目前人數</span>
        <div class="crowd-status">
          <div id="crowd-indicator" class="crowd-indicator"></div>
          <span id="current-count" class="info-value">--</span>
        </div>
      </div>
      <div class="info-item">
        <span class="info-label">整體平均</span>
        <span id="overall-avg" class="info-value">-- 人</span>
      </div>
      <div class="info-item">
        <span class="info-label">擁擠程度</span>
        <span id="crowd-level" class="info-value crowd-level">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">對比值</span>
        <span id="comparison-ratio" class="info-value">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">資料筆數</span>
        <span id="data-count" class="info-value">-- 筆</span>
      </div>
      <div class="info-item">
        <span class="info-label">查詢時間</span>
        <span id="query-time" class="info-value">--</span>
      </div>
      <div class="info-item" id="distance-item" style="display: none;">
        <span class="info-label">距離</span>
        <span id="distance-value" class="info-value">-- km</span>
      </div>
    </div>
  </div>
  
  <!-- 左側時間控制器 -->
  <div class="time-control left" id="time-control-left">
    <div class="time-slider-container">
      <div class="time-label">往前 ←</div>
      <input type="range" class="time-slider" id="time-slider-left" min="0" max="47" value="0" step="1">
      <div class="time-display" id="time-display-left">00:00</div>
    </div>
  </div>
  
  <!-- 雷達按鈕 -->
  <div id="radar-fab">
    <canvas id="radar-canvas" width="60" height="60"></canvas>
  </div>
  
  <!-- 右側時間控制器 -->
  <div class="time-control right" id="time-control-right">
    <div class="time-slider-container">
      <div class="time-label">→ 往後</div>
      <input type="range" class="time-slider" id="time-slider-right" min="0" max="47" value="0" step="1">
      <div class="time-display" id="time-display-right">00:00</div>
    </div>
  </div>
  <div id="glass-panel">
    <button id="close-panel">✕</button>
    <button id="settings-panel">⚙</button>
    <button id="clear-chat" title="清除對話歷史 (無法復原)">🗑️</button>
    <div id="advice-title">人潮雷達</div>
    <div id="advice-content">請點選地圖上的檢查點或輸入需求，AI 將根據交通狀況與歷史資料給出最佳建議。</div>
    <div id="chat-history"></div>
    <input id="prompt-input" type="text" placeholder="請輸入需求，例如：我想從 a5 經過 a3 到 a2" />
    <button id="ask-btn">Ask for help</button>
  </div>

  <div id="settings-modal">
    <div id="settings-form">
      <h3>設定</h3>
      <label for="custom-prompt">客製化提示詞：</label>
      <textarea id="custom-prompt" placeholder="輸入您的客製化提示詞，例如：我希望AI回應更詳細一些，並提供具體的時間建議..."></textarea>
      <div class="settings-buttons">
        <button class="settings-btn cancel" id="cancel-settings">取消</button>
        <button class="settings-btn save" id="save-settings">儲存</button>
      </div>
    </div>
  </div>

  <script>
    let key = '';
    fetch('/api/azure-maps-key')
      .then(res => res.json())
      .then(data => {
        key = data.key;
        // 取得金鑰後再初始化地圖
        initMap();
      });

    function initMap() {
      const map = new atlas.Map('map', {
        center: [121.5654, 25.034],
        zoom: 17,
        style: 'road', 
        authOptions: {
          authType: 'subscriptionKey',
          subscriptionKey: key
        }
      });

      let crowdData = [];
      let currentLat = null;
      let currentLon = null;
      let currentTimeOffset = 0; // 時間偏移量，0表示當前時間，正數表示往後，負數表示往前

      // 資訊卡管理
      const infoCard = document.getElementById('location-info-card');
      const infoCardClose = document.getElementById('info-card-close');
      let currentShowingLocation = null; // 追蹤當前顯示的地點
      
      function showLocationInfo(checkpoint) {
        // 更新資訊卡內容
        document.getElementById('info-card-title').textContent = checkpoint.name;
        document.getElementById('current-count').textContent = `${checkpoint.avg_count} 人`;
        document.getElementById('overall-avg').textContent = `${checkpoint.overall_avg} 人`;
        document.getElementById('comparison-ratio').textContent = checkpoint.comparison_ratio?.toFixed(3) || 'N/A';
        document.getElementById('data-count').textContent = `${checkpoint.current_data_count} / ${checkpoint.overall_data_count} 筆`;
        document.getElementById('query-time').textContent = checkpoint.query_time || getCurrentTimeString();
        
        // 處理距離顯示
        const distanceItem = document.getElementById('distance-item');
        const distanceValue = document.getElementById('distance-value');
        if (checkpoint.distance !== null && checkpoint.distance !== undefined) {
          const distanceKm = (checkpoint.distance * 111).toFixed(2); // 轉換為公里（粗略）
          distanceValue.textContent = `${distanceKm} km`;
          distanceItem.style.display = 'flex';
        } else {
          distanceItem.style.display = 'none';
        }
        
        // 設定擁擠程度和顏色
        const levelText = getLevelText(checkpoint.comparison_ratio);
        const levelColor = getDynamicColor(checkpoint.comparison_ratio);
        
        document.getElementById('crowd-level').textContent = levelText;
        document.getElementById('crowd-level').style.background = levelColor + '40'; // 40% 透明度
        document.getElementById('crowd-level').style.color = levelColor;
        
        // 設定指示器顏色
        const indicator = document.getElementById('crowd-indicator');
        indicator.style.color = levelColor;
        indicator.style.background = levelColor;
        
        // 記錄當前顯示的地點
        currentShowingLocation = checkpoint.name;
        
        // 顯示資訊卡
        infoCard.classList.add('show');
        
        console.log('📋 顯示地點資訊:', checkpoint.name);
      }
      
      function hideLocationInfo() {
        infoCard.classList.remove('show');
        currentShowingLocation = null;
        console.log('📋 隱藏地點資訊');
      }
      
      function updateCurrentLocationInfo() {
        // 如果有地點正在顯示，更新其資訊
        if (currentShowingLocation && crowdData.length > 0) {
          const checkpoint = crowdData.find(item => item.name === currentShowingLocation);
          if (checkpoint) {
            console.log('🔄 更新資訊卡內容:', currentShowingLocation);
            showLocationInfo(checkpoint);
          }
        }
      }
      
      // 關閉按鈕事件
      infoCardClose.addEventListener('click', hideLocationInfo);
      
      // 點擊卡片外部隱藏
      document.addEventListener('click', function(e) {
        if (!infoCard.contains(e.target) && !e.target.closest('.custom-marker')) {
          hideLocationInfo();
        }
      });

      // 時間軸相關函數
      function indexToTime(index) {
        // 將 0-47 的索引轉換為 00:00 到 23:30 的時間
        const hours = Math.floor(index / 2);
        const minutes = (index % 2) * 30;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      }

      function timeToIndex(timeStr) {
        // 將 HH:MM 時間轉換為 0-47 的索引
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 2 + (minutes >= 30 ? 1 : 0);
      }

      function getCurrentTimeIndex() {
        // 獲取當前時間對應的索引
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        return hours * 2 + (minutes >= 30 ? 1 : 0);
      }

      function updateTimeDisplay(side, index) {
        // 更新時間顯示
        const timeStr = indexToTime(index);
        document.getElementById(`time-display-${side}`).textContent = timeStr;
      }

      function getQueryTime() {
        // 根據當前偏移量計算查詢時間
        const currentIndex = getCurrentTimeIndex();
        const targetIndex = Math.max(0, Math.min(47, currentIndex + currentTimeOffset));
        return indexToTime(targetIndex);
      }

      async function loadCheckpoints(queryTime = null) {
        try {
          // 構建 API URL，如果有用戶位置就加上參數
          let apiUrl = '/api/checkpoints';
          const params = new URLSearchParams();
          
          if (currentLat !== null && currentLon !== null) {
            params.append('lat', currentLat);
            params.append('lon', currentLon);
            console.log(`使用用戶位置 (${currentLat}, ${currentLon}) 篩選最近的地點`);
          } else {
            console.log('沒有用戶位置，顯示所有地點');
          }
          
          // 添加時間參數
          if (queryTime) {
            params.append('time', queryTime);
            console.log(`查詢時間: ${queryTime}`);
          }
          
          if (params.toString()) {
            apiUrl += '?' + params.toString();
          }
          
          console.log('🔍 API請求:', apiUrl);
          const res = await fetch(apiUrl);
          
          if (!res.ok) {
            throw new Error(`API錯誤: ${res.status} ${res.statusText}`);
          }
          
          const responseText = await res.text();
          console.log('📥 API響應長度:', responseText.length);
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (jsonError) {
            console.error('JSON解析錯誤:', jsonError);
            console.error('響應內容:', responseText.substring(0, 500));
            throw new Error('服務器返回無效的JSON數據');
          }
          
          if (data.error) {
            throw new Error(`服務器錯誤: ${data.error}`);
          }
          
          crowdData = data;
          console.log(`✅ 載入了 ${crowdData.length} 個地點`);
          
          // 清除現有標記並重新添加
          map.markers.clear();
          
          // 重新添加用戶標記（如果有的話）
          if (currentLat !== null && currentLon !== null) {
            const userPin = new atlas.HtmlMarker({
              color: 'blue',
              text: 'U',
              position: [currentLon, currentLat]
            });
            map.markers.add(userPin);
          }
          
          // 後端已經計算好 level，直接使用
          addCheckpointsToMap();
          
          // 如果資訊卡正在顯示，更新其內容
          updateCurrentLocationInfo();
          
        } catch (error) {
          console.error('❌ loadCheckpoints錯誤:', error);
          // 用戶友善的錯誤提示
          if (map && map.getCanvas) {
            // 可以在地圖上顯示錯誤提示
            console.warn('地點載入失敗，請稍後重試');
          }
        }
      }

      function addCheckpointsToMap() {
        crowdData.forEach((checkpoint) => {
          // 防護檢查：確保 level 存在且有值
          const level = checkpoint.level || 'unknown';
          const avgCount = checkpoint.avg_count || checkpoint.person_count || 0;
          const dataCount = checkpoint.data_count || 0;
          
          // 動態顏色計算
          let markerColor;
          if (level === 'dynamic' && checkpoint.comparison_ratio !== undefined) {
            markerColor = getDynamicColor(checkpoint.comparison_ratio);
          } else {
            markerColor = crowdColor[level] || 'gray';
          }
          
          const popup = new atlas.Popup({
            content: `<div style="padding:8px">
              <b>${checkpoint.name}</b><br>
              當前平均：<span style="color:${markerColor};font-weight:bold">${avgCount}人</span><br>
              整體平均：${checkpoint.overall_avg || 'N/A'}人<br>
              對比值：<span style="color:${markerColor};font-weight:bold">${checkpoint.comparison_ratio || 'N/A'}</span><br>
              資料筆數：${dataCount}筆<br>
              擁擠程度：<span style="color:${markerColor};font-weight:bold">${getLevelText(checkpoint.comparison_ratio)}</span>
            </div>`
          });

          // 創建自定義的液態玻璃風格圖標
          const customMarker = document.createElement('div');
          customMarker.className = 'custom-marker';
          customMarker.innerHTML = `
            <div class="marker-glass" style="
              background: rgba(255,255,255,0.25);
              backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px);
              border-radius: 16px;
              border: 1px solid rgba(255,255,255,0.18);
              padding: 8px 12px;
              box-shadow: 0 4px 16px rgba(31,38,135,0.3);
              display: flex;
              align-items: center;
              gap: 8px;
              min-width: 80px;
              max-width: 120px;
              transition: all 0.2s ease;
            ">
              <div class="marker-dot" style="
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: ${markerColor};
                box-shadow: 0 0 8px ${markerColor};
                flex-shrink: 0;
              "></div>
              <div class="marker-text" style="
                color: #222;
                font-size: 12px;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(255,255,255,0.3);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              ">${checkpoint.name}</div>
            </div>
          `;

          // 添加懸停效果
          customMarker.addEventListener('mouseenter', function() {
            this.querySelector('.marker-glass').style.transform = 'scale(1.05)';
            this.querySelector('.marker-glass').style.boxShadow = '0 6px 20px rgba(31,38,135,0.4)';
          });
          
          customMarker.addEventListener('mouseleave', function() {
            this.querySelector('.marker-glass').style.transform = 'scale(1)';
            this.querySelector('.marker-glass').style.boxShadow = '0 4px 16px rgba(31,38,135,0.3)';
          });

          // 創建 Azure Maps 標記
          const pin = new atlas.HtmlMarker({
            htmlContent: customMarker,
            position: [checkpoint.lon, checkpoint.lat],
            anchor: 'center'
          });

          map.markers.add(pin);
          
          // 綁定點擊事件
          setTimeout(() => {
            pin.getElement().addEventListener('click', (e) => {
              e.stopPropagation();
              
              // 移除彈出窗口，使用資訊卡替代
              // popup.open(map, pin.getOptions().position);
              
              // 將地圖中心移動到點擊的地點
              map.setCamera({ 
                center: [checkpoint.lon, checkpoint.lat], 
                zoom: 18,
                duration: 800 // 平滑動畫
              });
              
              // 顯示資訊卡
              showLocationInfo(checkpoint);
            });
          }, 0);
        });
      }

      const crowdColor = {
        very_low: 'darkgreen',
        low: 'green',
        mid: 'orange',
        high: 'red',
        unknown: 'gray'
      };

      map.events.add('ready', function () {
        // 先載入地點資料（沒有位置篩選）
        loadCheckpoints();
        
        // 嘗試獲得使用者即時位置
        if (navigator.geolocation) {
          console.log('🔍 嘗試獲取用戶位置...');
          
          navigator.geolocation.getCurrentPosition(
            function (position) {
              // 成功獲取位置
              console.log('✅ 成功獲取實際位置');
              currentLat = position.coords.latitude;
              currentLon = position.coords.longitude;
              
              // 臨時使用日本位置進行測試
              currentLat = 35.6329;
              currentLon = 139.88056;
              
              console.log(`📍 用戶位置設定為: (${currentLat}, ${currentLon})`);
              map.setCamera({ center: [currentLon, currentLat], zoom: 18 });

              const userPopup = new atlas.Popup({
                content: `<div style="padding:5px"><b>你在這裡</b></div>`
              });
              const userPin = new atlas.HtmlMarker({
                color: 'blue',
                text: 'U',
                position: [currentLon, currentLat]
              });
              map.markers.add(userPin);
              
              setTimeout(() => {
                userPin.getElement().addEventListener('click', (e) => {
                  e.stopPropagation();
                  userPopup.open(map, userPin.getOptions().position);
                  map.setCamera({ center: [currentLon, currentLat], zoom: 19 });
                });
              }, 0);
              
              // 位置設定完成後，重新載入地點資料（使用距離篩選）
              console.log('🔄 用戶位置已設定，重新載入最近的地點');
              // 清除現有的地圖標記
              map.markers.clear();
              // 重新添加用戶標記
              map.markers.add(userPin);
              // 重新載入地點資料
              loadCheckpoints();
            },
            function (error) {
              // 位置獲取失敗的處理
              console.warn('⚠️ 位置獲取失敗:', error);
              console.warn('錯誤代碼:', error.code);
              console.warn('錯誤訊息:', error.message);
              
              // 提供備用位置（預設台北）
              currentLat = 25.034;
              currentLon = 121.5654;
              console.log(`📍 使用備用位置: (${currentLat}, ${currentLon})`);
              
              map.setCamera({ center: [currentLon, currentLat], zoom: 15 });
              
              // 顯示備用位置標記
              const fallbackPin = new atlas.HtmlMarker({
                color: 'orange',
                text: '?',
                position: [currentLon, currentLat]
              });
              map.markers.add(fallbackPin);
              
              // 重新載入地點資料
              loadCheckpoints();
            },
            {
              // 位置獲取選項
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000
            }
          );
        } else {
          console.warn('⚠️ 瀏覽器不支援地理位置服務');
          // 瀏覽器不支援位置服務時的備用處理
          currentLat = 25.034;
          currentLon = 121.5654;
          map.setCamera({ center: [currentLon, currentLat], zoom: 15 });
          loadCheckpoints();
        }
      });

      function getCurrentTimeString() {
        const now = new Date();
        return now.toTimeString().slice(0,5); // 例如 "14:00"
      }

      const chatHistory = document.getElementById('chat-history');

      // 短期記憶功能 - localStorage 對話歷史管理
      const CHAT_STORAGE_KEY = 'crowdRadarChatHistory';
      const MAX_CHAT_MESSAGES = 50; // 限制最大訊息數量以避免localStorage過大

      // 檢測 localStorage 可用性
      function isLocalStorageAvailable() {
        try {
          const test = '__localStorage_test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }

      const hasLocalStorage = isLocalStorageAvailable();
      if (!hasLocalStorage) {
        console.warn('⚠️ localStorage 不可用，對話歷史功能已停用');
      }

      function saveChatHistory() {
        if (!hasLocalStorage) return; // localStorage 不可用時直接返回
        
        try {
          const messages = Array.from(chatHistory.children).map(msg => ({
            role: msg.classList.contains('user') ? 'user' : 'ai',
            content: msg.classList.contains('user') ? msg.textContent : msg.innerHTML,
            timestamp: Date.now()
          }));
          
          // 只保留最新的訊息
          const limitedMessages = messages.slice(-MAX_CHAT_MESSAGES);
          localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(limitedMessages));
          
          // 更新標題顯示訊息數量（可選的視覺回饋）
          if (limitedMessages.length > 0) {
            console.log(`💾 已保存 ${limitedMessages.length} 條對話記錄`);
          }
        } catch (error) {
          console.warn('無法保存對話歷史:', error);
        }
      }

      function loadChatHistory() {
        if (!hasLocalStorage) return; // localStorage 不可用時直接返回
        
        try {
          const savedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
          if (savedHistory) {
            const messages = JSON.parse(savedHistory);
            
            // 清空現有對話
            chatHistory.innerHTML = '';
            
            // 恢復對話記錄
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message ' + msg.role;
              
              if (msg.role === 'ai') {
                div.innerHTML = msg.content; // AI訊息支援HTML/Markdown
              } else {
                div.textContent = msg.content; // 用戶訊息純文字
              }
              
              chatHistory.appendChild(div);
            });
            
            // 滾動到底部
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            console.log(`🔄 恢復了 ${messages.length} 條對話記錄`);
          }
        } catch (error) {
          console.warn('無法載入對話歷史:', error);
          // 如果載入失敗，清除損壞的數據
          if (hasLocalStorage) {
            localStorage.removeItem(CHAT_STORAGE_KEY);
          }
        }
      }

      function clearChatHistory() {
        if (hasLocalStorage) {
          localStorage.removeItem(CHAT_STORAGE_KEY);
        }
        chatHistory.innerHTML = '';
        console.log('🗑 對話歷史已清除');
      }

      function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = 'message ' + (role === 'user' ? 'user' : 'ai');
        if (role === 'ai') {
          div.innerHTML = marked.parse(text); // 支援 markdown
        } else {
          div.innerText = text;
        }
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        // 每次添加訊息後保存到localStorage
        saveChatHistory();
      }

      function getChatContext() {
        // 獲取對話上下文，用於發送給 AI
        if (!hasLocalStorage) return [];
        
        try {
          const savedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
          if (savedHistory) {
            const messages = JSON.parse(savedHistory);
            
            // 過濾掉系統訊息（如清除歷史的提示）
            const validMessages = messages.filter(msg => 
              !msg.content.includes('對話歷史已清除') && 
              !msg.content.includes('AI 正在思考中') &&
              !msg.content.includes('✨') &&
              msg.content.trim().length > 0
            );
            
            // 增加上下文長度，取最近的 12 條對話（6組對話）
            const recentMessages = validMessages.slice(-12).map(msg => ({
              role: msg.role === 'user' ? 'user' : 'assistant',
              content: msg.role === 'user' ? 
                msg.content : 
                msg.content.replace(/<[^>]*>/g, '').replace(/\n+/g, ' ').trim() // 清理 HTML 和多餘空行
            }));
            
            console.log(`📝 準備發送 ${recentMessages.length} 條對話作為上下文`);
            console.log('上下文內容預覽:', recentMessages.slice(-4)); // 顯示最近4條
            return recentMessages;
          }
        } catch (error) {
          console.warn('無法獲取對話上下文:', error);
        }
        
        return [];
      }

      document.getElementById('ask-btn').addEventListener('click', async () => {
        const allLocations = crowdData.map(cp => cp.name); // 例如 ["K館", "福利社", ...]
        const prompt = document.getElementById('prompt-input').value.trim();
        const customPrompt = localStorage.getItem('customPrompt') || '';

        // 防止發送空訊息
        if (!prompt) {
          return;
        }

        // 獲取對話歷史作為上下文
        const chatContext = getChatContext();

        appendMessage('user', prompt);
        document.getElementById('prompt-input').value = '';
        appendMessage('ai', 'AI 正在思考中...');
        console.log('📤 發送的用戶訊息:', prompt);
        console.log('📚 發送的對話上下文:', chatContext);
        console.log('🔢 上下文條數:', chatContext.length);
        
        try {
          const response = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt,
              locations: allLocations,
              current_location: { lat: currentLat, lon: currentLon },
              current_time: getCurrentTimeString(),
              custom_prompt: customPrompt,
              chat_history: chatContext // 新增：傳送對話歷史
            })
          });
          const data = await response.json();

          // 移除「AI 正在思考中...」
          const lastMsg = chatHistory.querySelector('.message.ai:last-child');
          if (lastMsg && lastMsg.innerText === 'AI 正在思考中...') {
            lastMsg.remove();
          }
          appendMessage('ai', data.reply || 'AI 沒有回應');
        } catch (error) {
          console.error('發送訊息失敗:', error);
          // 移除「AI 正在思考中...」
          const lastMsg = chatHistory.querySelector('.message.ai:last-child');
          if (lastMsg && lastMsg.innerText === 'AI 正在思考中...') {
            lastMsg.remove();
          }
          appendMessage('ai', '訊息發送失敗，請稍後再試');
        }
        
        // 確保輸入框重新獲得焦點
        setTimeout(() => {
          promptInput.focus();
        }, 100);
      });

      // 畫雷達圖
      function drawRadar() {
        const canvas = document.getElementById('radar-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,60,60);
        // 外圈
        ctx.globalAlpha = 0.18;
        ctx.beginPath();
        ctx.arc(30,30,28,0,2*Math.PI);
        ctx.fillStyle = '#222';
        ctx.fill();
        // 內圈
        ctx.globalAlpha = 0.35;
        ctx.beginPath();
        ctx.arc(30,30,18,0,2*Math.PI);
        ctx.fillStyle = '#888';
        ctx.fill();
        // 中心
        ctx.globalAlpha = 0.7;
        ctx.beginPath();
        ctx.arc(30,30,7,0,2*Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        // 雷達線
        ctx.globalAlpha = 0.7;
        ctx.strokeStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(30,30);
        ctx.lineTo(30,5);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(30,30);
        ctx.lineTo(55,30);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }
      drawRadar();

      // 開關聊天室
      const radarFab = document.getElementById('radar-fab');
      const glassPanel = document.getElementById('glass-panel');
      const closePanel = document.getElementById('close-panel');
      const clearChatBtn = document.getElementById('clear-chat');

      radarFab.addEventListener('click', () => {
        glassPanel.classList.add('open');
        radarFab.style.display = 'none';
      });
      closePanel.addEventListener('click', () => {
        glassPanel.classList.remove('open');
        setTimeout(() => { radarFab.style.display = 'flex'; }, 400);
      });

      clearChatBtn.addEventListener('click', () => {
        if (confirm('確定要清除所有對話歷史嗎？此操作無法復原。')) {
          clearChatHistory();
          appendMessage('ai', '✨ 對話歷史已清除，我們重新開始吧！');
        }
      });

      // 設定功能
      const settingsPanel = document.getElementById('settings-panel');
      const settingsModal = document.getElementById('settings-modal');
      const saveSettings = document.getElementById('save-settings');
      const cancelSettings = document.getElementById('cancel-settings');
      const customPromptInput = document.getElementById('custom-prompt');

      // 載入已儲存的設定
      const savedCustomPrompt = localStorage.getItem('customPrompt') || '';
      customPromptInput.value = savedCustomPrompt;

      settingsPanel.addEventListener('click', () => {
        settingsModal.classList.add('open');
      });

      cancelSettings.addEventListener('click', () => {
        settingsModal.classList.remove('open');
        customPromptInput.value = savedCustomPrompt; // 恢復原值
      });

      saveSettings.addEventListener('click', () => {
        const customPrompt = customPromptInput.value.trim();
        localStorage.setItem('customPrompt', customPrompt);
        settingsModal.classList.remove('open');
        
        // 顯示儲存成功訊息
        const tempMsg = document.createElement('div');
        tempMsg.textContent = '設定已儲存';
        tempMsg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,120,212,0.9);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 100;
          font-size: 14px;
        `;
        document.body.appendChild(tempMsg);
        setTimeout(() => tempMsg.remove(), 2000);
      });

      // 點擊背景關閉設定
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('open');
          customPromptInput.value = savedCustomPrompt; // 恢復原值
        }
      });

      // Enter 送出訊息
      const promptInput = document.getElementById('prompt-input');
      promptInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          // 檢查是否有內容
          const inputValue = this.value.trim();
          console.log('Enter鍵按下，輸入內容:', inputValue);
          
          if (inputValue) {
            // 觸發發送訊息按鈕
            document.getElementById('ask-btn').click();
            console.log('✅ 訊息已發送，輸入框應已清空');
          } else {
            console.log('⚠️ 輸入框為空，不發送訊息');
          }
          
          // 確保輸入框保持焦點
          setTimeout(() => {
            this.focus();
            console.log('🎯 輸入框重新獲得焦點');
          }, 100);
        }
      });

      // 確保輸入框在發送後重新獲得焦點
      // document.getElementById('ask-btn').addEventListener('click', function() {
      //   setTimeout(() => {
      //     promptInput.focus();
      //   }, 100);
      // });

      // 禁用地圖縮放（假設 map 變數可用）
      promptInput.addEventListener('focus', function() {
        console.log('📝 輸入框獲得焦點');
        if (map && map.controls) {
          map.controls.remove('zoom');
        }
        // 手機自動彈出鍵盤
        setTimeout(() => promptInput.scrollIntoView({behavior: 'smooth', block: 'center'}), 100);
      });
      promptInput.addEventListener('blur', function() {
        console.log('📝 輸入框失去焦點');
        // 恢復地圖縮放
        // map.controls.add('zoom'); // 根據你的地圖API調整
      });

      // 初始化時間軸控制器
      function initTimeControls() {
        const leftSlider = document.getElementById('time-slider-left');
        const rightSlider = document.getElementById('time-slider-right');
        const currentIndex = getCurrentTimeIndex();
        
        // 設置初始值
        leftSlider.value = 47; // 左側滑桿初始位於最右邊（現在時間）
        rightSlider.value = 0; // 右側滑桿初始位於最左邊
        updateTimeDisplay('left', currentIndex);
        updateTimeDisplay('right', currentIndex);
        
        // 左側滑桿（往前）- 從右(47)往左(0)滑動查看過去
        leftSlider.addEventListener('input', function(e) {
          const value = parseInt(e.target.value);
          // 值越小，時間越往前
          const stepsBack = 47 - value; // 從右邊(47)開始，往左滑動
          currentTimeOffset = -stepsBack;
          
          // 計算並顯示實際時間
          const targetIndex = Math.max(0, currentIndex + currentTimeOffset);
          updateTimeDisplay('left', targetIndex);
          
          // 重置右側滑桿
          rightSlider.value = 0;
          updateTimeDisplay('right', currentIndex);
          
          // 只有當時間偏移不為0時才更新地圖資料
          if (currentTimeOffset !== 0) {
            const queryTime = getQueryTime();
            loadCheckpoints(queryTime);
          } else {
            loadCheckpoints(); // 回到當前時間，不傳遞時間參數
          }
        });
        
        // 右側滑桿（往後）- 從左(0)往右(47)滑動查看未來
        rightSlider.addEventListener('input', function(e) {
          const value = parseInt(e.target.value);
          currentTimeOffset = value; // 左到右滑動表示往後
          
          // 計算並顯示實際時間
          const targetIndex = Math.min(47, currentIndex + value);
          updateTimeDisplay('right', targetIndex);
          
          // 重置左側滑桿到初始位置（最右邊）
          leftSlider.value = 47;
          updateTimeDisplay('left', currentIndex);
          
          // 只有當時間偏移不為0時才更新地圖資料
          if (currentTimeOffset !== 0) {
            const queryTime = getQueryTime();
            loadCheckpoints(queryTime);
          } else {
            loadCheckpoints(); // 回到當前時間，不傳遞時間參數
          }
        });
        
        console.log('時間軸控制器初始化完成');
        console.log(`當前時間索引: ${currentIndex} (${indexToTime(currentIndex)})`);
      }
      
      // 在地圖準備好後初始化時間控制器
      setTimeout(() => {
        initTimeControls();
        loadChatHistory(); // 初始化時加載對話歷史
      }, 1000);

      // 動態顏色計算函數
      function getDynamicColor(ratio) {
        // ratio 範圍：-1 到 1
        // -1: 深綠色（很空）
        // 0: 黃色（正常）
        // 1: 深紅色（很擁擠）
        
        if (ratio <= -0.5) {
          // 深綠色到綠色
          const intensity = Math.abs(ratio + 0.5) * 2; // 0 到 1
          return `rgb(0, ${100 + Math.floor(intensity * 155)}, 0)`;
        } else if (ratio <= 0) {
          // 綠色到黃色
          const intensity = (ratio + 0.5) * 2; // 0 到 1
          return `rgb(${Math.floor(intensity * 255)}, ${255 - Math.floor(intensity * 100)}, 0)`;
        } else if (ratio <= 0.5) {
          // 黃色到橙色
          const intensity = ratio * 2; // 0 到 1
          return `rgb(255, ${255 - Math.floor(intensity * 165)}, 0)`;
        } else {
          // 橙色到深紅色
          const intensity = (ratio - 0.5) * 2; // 0 到 1
          return `rgb(255, ${90 - Math.floor(intensity * 90)}, 0)`;
        }
      }

      // 根據對比值取得等級文字
      function getLevelText(ratio) {
        if (ratio === undefined || ratio === null) return 'UNKNOWN';
        
        if (ratio <= -0.3) return 'VERY LOW';
        if (ratio <= -0.1) return 'LOW';
        if (ratio <= 0.1) return 'NORMAL';
        if (ratio <= 0.3) return 'HIGH';
        return 'VERY HIGH';
      }
    }
  </script>
</body>
</html>