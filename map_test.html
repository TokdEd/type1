<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>äººæ½®é›·é”åŸå‹ | Azure Maps</title>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: Arial;
      overflow: hidden;
    }
    #map {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0; left: 0;
      z-index: 0;
    }
    #radar-fab {
      position: fixed;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      background: rgba(255,255,255,0.25);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.18);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
    }
    #radar-fab:hover {
      box-shadow: 0 12px 40px 0 rgba(31,38,135,0.45);
      background: rgba(255,255,255,0.35);
    }
    
    /* æ™‚é–“è»¸æ§åˆ¶å™¨ */
    .time-control {
      position: fixed;
      bottom: 4vh;
      transform: translateY(-50%);
      z-index: 19;
      display: flex;
      align-items: center;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .time-control.left {
      left: calc(50% - 200px);
    }
    
    .time-control.right {
      right: calc(50% - 200px);
    }
    
    .time-slider-container {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 12px 20px;
      box-shadow: 0 6px 24px rgba(31,38,135,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }
    
    .time-label {
      color: #222;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255,255,255,0.3);
      letter-spacing: 0.5px;
    }
    
    .time-slider {
      width: 100px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      position: relative;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .time-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .time-display {
      color: #333;
      font-size: 12px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(255,255,255,0.4);
      min-width: 50px;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .time-control.left {
        left: 10px;
      }
      .time-control.right {
        right: 10px;
      }
      .time-slider-container {
        min-width: 100px;
        padding: 10px 16px;
      }
      .time-slider {
        width: 80px;
      }
    }
    #glass-panel {
      position: fixed;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%) scale(0.98);
      width: 94vw;
      max-width: 480px;
      min-height: 60vh;
      max-height: 88vh;
      background: rgba(255,255,255,0.18);
      box-shadow: 0 12px 48px 0 rgba(31,38,135,0.45);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 32px;
      border: 1.5px solid rgba(255,255,255,0.18);
      z-index: 30;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      transition: transform 0.35s cubic-bezier(.4,1.6,.4,1), opacity 0.3s;
      opacity: 0;
      pointer-events: none;
      padding: 32px 18px 20px 18px;
      box-sizing: border-box;
    }
    #glass-panel.open {
      transform: translateX(-50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 600px) {
      #glass-panel {
        width: 98vw;
        max-width: 99vw;
        min-height: 80vh;
        left: 50%;
        bottom: 0;
        padding: 24px 4vw 16px 4vw;
      }
      #chat-history {
        max-height: 400px;
      }
      #clear-chat {
        left: 60px; /* åœ¨å°è¢å¹•ä¸Šç¨å¾®èª¿æ•´ä½ç½® */
        width: 28px;
        height: 28px;
        font-size: 1em;
      }
    }
    #close-panel {
      position: absolute;
      top: 18px;
      right: 24px;
      background: rgba(0,0,0,0.08);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2em;
      color: #333;
      cursor: pointer;
      z-index: 40;
      transition: background 0.2s;
    }
    #close-panel:hover {
      background: rgba(0,0,0,0.18);
    }
    #settings-panel {
      position: absolute;
      top: 18px;
      left: 24px;
      background: rgba(0,0,0,0.08);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2em;
      color: #333;
      cursor: pointer;
      z-index: 40;
      transition: background 0.2s;
    }
    #settings-panel:hover {
      background: rgba(0,0,0,0.18);
    }
    #clear-chat {
      position: absolute;
      top: 18px;
      left: 66px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,69,58,0.3);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.1em;
      color: #ff6b6b;
      cursor: pointer;
      z-index: 40;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      box-shadow: 0 4px 16px rgba(255,69,58,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clear-chat:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,69,58,0.5);
      color: #ff453a;
      transform: scale(1.08) translateY(-1px);
      box-shadow: 0 6px 20px rgba(255,69,58,0.3);
    }
    #clear-chat:active {
      transform: scale(0.96) translateY(0px);
      box-shadow: 0 2px 8px rgba(255,69,58,0.25);
      background: rgba(255,255,255,0.2);
    }
    #settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #settings-modal.open {
      opacity: 1;
      pointer-events: auto;
    }
    #settings-form {
      background: rgba(255,255,255,0.25);
      box-shadow: 0 12px 48px 0 rgba(31,38,135,0.45);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1.5px solid rgba(255,255,255,0.18);
      padding: 32px;
      max-width: 480px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
    }
    #settings-form h3 {
      margin: 0 0 20px 0;
      color: #222;
      font-size: 1.3em;
      text-align: center;
    }
    #settings-form label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }
    #custom-prompt {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border: 1px solid rgba(200,200,200,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.25);
      color: #222;
      font-size: 1em;
      resize: vertical;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      outline: none;
      transition: border 0.2s;
      box-sizing: border-box;
    }
    #custom-prompt:focus {
      border: 1.5px solid #0078d4;
      background: rgba(255,255,255,0.35);
    }
    .settings-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .settings-btn {
      flex: 1;
      padding: 12px 0;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .settings-btn.save {
      background: rgba(0,120,212,0.25);
      color: #fff;
    }
    .settings-btn.save:hover {
      background: rgba(0,95,163,0.35);
    }
    .settings-btn.cancel {
      background: rgba(128,128,128,0.25);
      color: #fff;
    }
    .settings-btn.cancel:hover {
      background: rgba(96,96,96,0.35);
    }
    #prompt-input {
      width: 95%;
      max-width: 520px;
      padding: 14px 18px;
      border: 1px solid rgba(200,200,200,0.18);
      border-radius: 16px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.18);
      color: #222;
      font-size: 1.08em;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      outline: none;
      transition: border 0.2s;
    }
    #prompt-input:focus {
      border: 1.5px solid #0078d4;
      background: rgba(255,255,255,0.28);
    }
    #ask-btn {
      width: 95%;
      max-width: 520px;
      padding: 14px 0;
      background: rgba(0,120,212,0.22);
      color: #fff;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1.08em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: background 0.2s;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    #ask-btn:hover {
      background: rgba(0,95,163,0.32);
    }
    #advice-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 8px;
      color: #222;
      text-shadow: 0 1px 2px rgba(255,255,255,0.2);
    }
    #advice-content {
      font-size: 1em;
      color: #333;
      margin-bottom: 8px;
      text-align: center;
      word-break: break-all;
    }
    #chat-history {
      width: 100%;
      max-width: 520px;
      min-height: 180px;
      max-height: 350px;
      overflow-y: auto;
      background: rgba(255,255,255,0.13);
      border-radius: 18px;
      margin-bottom: 10px;
      padding: 16px 12px 16px 12px;
      box-sizing: border-box;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      font-size: 1em;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .message {
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 90%;
      word-break: break-word;
      margin-bottom: 2px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .message.user {
      align-self: flex-end;
      background: rgba(0,120,212,0.18);
      color: #1a2a3a;
    }
    .message.ai {
      align-self: flex-start;
      background: rgba(255,255,255,0.7);
      color: #222;
    }
    /* åœ°é»è³‡è¨Šå¡æ¨£å¼ */
    .location-info-card {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      width: 90vw;
      max-width: 400px;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1.5px solid rgba(255,255,255,0.18);
      box-shadow: 0 12px 48px rgba(31,38,135,0.4);
      padding: 24px;
      z-index: 25;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .location-info-card.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1);
    }
    
    .info-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .info-card-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #222;
      text-shadow: 0 1px 2px rgba(255,255,255,0.3);
      margin: 0;
    }
    
    .info-card-close {
      background: rgba(0,0,0,0.1);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1em;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .info-card-close:hover {
      background: rgba(0,0,0,0.2);
      color: #333;
    }
    
    .info-card-content {
      display: grid;
      gap: 12px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .info-label {
      font-size: 0.9em;
      color: #555;
      font-weight: 500;
    }
    
    .info-value {
      font-size: 1em;
      font-weight: 600;
      color: #222;
    }
    
    .info-value.crowd-level {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.85em;
      text-shadow: none;
    }
    
    .crowd-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .crowd-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 8px currentColor;
    }
    
    @media (max-width: 600px) {
      .location-info-card {
        width: 95vw;
        bottom: 100px;
        padding: 20px;
      }
      .info-card-title {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- åœ°é»è³‡è¨Šå¡ -->
  <div id="location-info-card" class="location-info-card">
    <div class="info-card-header">
      <h3 id="info-card-title" class="info-card-title">åœ°é»åç¨±</h3>
      <button id="info-card-close" class="info-card-close">âœ•</button>
    </div>
    <div class="info-card-content">
      <div class="info-item">
        <span class="info-label">ç›®å‰äººæ•¸</span>
        <div class="crowd-status">
          <div id="crowd-indicator" class="crowd-indicator"></div>
          <span id="current-count" class="info-value">--</span>
        </div>
      </div>
      <div class="info-item">
        <span class="info-label">æ•´é«”å¹³å‡</span>
        <span id="overall-avg" class="info-value">-- äºº</span>
      </div>
      <div class="info-item">
        <span class="info-label">æ“æ“ ç¨‹åº¦</span>
        <span id="crowd-level" class="info-value crowd-level">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">å°æ¯”å€¼</span>
        <span id="comparison-ratio" class="info-value">--</span>
      </div>
      <div class="info-item">
        <span class="info-label">è³‡æ–™ç­†æ•¸</span>
        <span id="data-count" class="info-value">-- ç­†</span>
      </div>
      <div class="info-item">
        <span class="info-label">æŸ¥è©¢æ™‚é–“</span>
        <span id="query-time" class="info-value">--</span>
      </div>
      <div class="info-item" id="distance-item" style="display: none;">
        <span class="info-label">è·é›¢</span>
        <span id="distance-value" class="info-value">-- km</span>
      </div>
    </div>
  </div>
  
  <!-- å·¦å´æ™‚é–“æ§åˆ¶å™¨ -->
  <div class="time-control left" id="time-control-left">
    <div class="time-slider-container">
      <div class="time-label">å¾€å‰ â†</div>
      <input type="range" class="time-slider" id="time-slider-left" min="0" max="47" value="0" step="1">
      <div class="time-display" id="time-display-left">00:00</div>
    </div>
  </div>
  
  <!-- é›·é”æŒ‰éˆ• -->
  <div id="radar-fab">
    <canvas id="radar-canvas" width="60" height="60"></canvas>
  </div>
  
  <!-- å³å´æ™‚é–“æ§åˆ¶å™¨ -->
  <div class="time-control right" id="time-control-right">
    <div class="time-slider-container">
      <div class="time-label">â†’ å¾€å¾Œ</div>
      <input type="range" class="time-slider" id="time-slider-right" min="0" max="47" value="0" step="1">
      <div class="time-display" id="time-display-right">00:00</div>
    </div>
  </div>
  <div id="glass-panel">
    <button id="close-panel">âœ•</button>
    <button id="settings-panel">âš™</button>
    <button id="clear-chat" title="æ¸…é™¤å°è©±æ­·å² (ç„¡æ³•å¾©åŸ)">ğŸ—‘ï¸</button>
    <div id="advice-title">äººæ½®é›·é”</div>
    <div id="advice-content">è«‹é»é¸åœ°åœ–ä¸Šçš„æª¢æŸ¥é»æˆ–è¼¸å…¥éœ€æ±‚ï¼ŒAI å°‡æ ¹æ“šäº¤é€šç‹€æ³èˆ‡æ­·å²è³‡æ–™çµ¦å‡ºæœ€ä½³å»ºè­°ã€‚</div>
    <div id="chat-history"></div>
    <input id="prompt-input" type="text" placeholder="è«‹è¼¸å…¥éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³å¾ a5 ç¶“é a3 åˆ° a2" />
    <button id="ask-btn">Ask for help</button>
  </div>

  <div id="settings-modal">
    <div id="settings-form">
      <h3>è¨­å®š</h3>
      <label for="custom-prompt">å®¢è£½åŒ–æç¤ºè©ï¼š</label>
      <textarea id="custom-prompt" placeholder="è¼¸å…¥æ‚¨çš„å®¢è£½åŒ–æç¤ºè©ï¼Œä¾‹å¦‚ï¼šæˆ‘å¸Œæœ›AIå›æ‡‰æ›´è©³ç´°ä¸€äº›ï¼Œä¸¦æä¾›å…·é«”çš„æ™‚é–“å»ºè­°..."></textarea>
      <div class="settings-buttons">
        <button class="settings-btn cancel" id="cancel-settings">å–æ¶ˆ</button>
        <button class="settings-btn save" id="save-settings">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let key = '';
    fetch('/api/azure-maps-key')
      .then(res => res.json())
      .then(data => {
        key = data.key;
        // å–å¾—é‡‘é‘°å¾Œå†åˆå§‹åŒ–åœ°åœ–
        initMap();
      });

    function initMap() {
      const map = new atlas.Map('map', {
        center: [121.5654, 25.034],
        zoom: 17,
        style: 'road', 
        authOptions: {
          authType: 'subscriptionKey',
          subscriptionKey: key
        }
      });

      let crowdData = [];
      let currentLat = null;
      let currentLon = null;
      let currentTimeOffset = 0; // æ™‚é–“åç§»é‡ï¼Œ0è¡¨ç¤ºç•¶å‰æ™‚é–“ï¼Œæ­£æ•¸è¡¨ç¤ºå¾€å¾Œï¼Œè² æ•¸è¡¨ç¤ºå¾€å‰

      // è³‡è¨Šå¡ç®¡ç†
      const infoCard = document.getElementById('location-info-card');
      const infoCardClose = document.getElementById('info-card-close');
      let currentShowingLocation = null; // è¿½è¹¤ç•¶å‰é¡¯ç¤ºçš„åœ°é»
      
      function showLocationInfo(checkpoint) {
        // æ›´æ–°è³‡è¨Šå¡å…§å®¹
        document.getElementById('info-card-title').textContent = checkpoint.name;
        document.getElementById('current-count').textContent = `${checkpoint.avg_count} äºº`;
        document.getElementById('overall-avg').textContent = `${checkpoint.overall_avg} äºº`;
        document.getElementById('comparison-ratio').textContent = checkpoint.comparison_ratio?.toFixed(3) || 'N/A';
        document.getElementById('data-count').textContent = `${checkpoint.current_data_count} / ${checkpoint.overall_data_count} ç­†`;
        document.getElementById('query-time').textContent = checkpoint.query_time || getCurrentTimeString();
        
        // è™•ç†è·é›¢é¡¯ç¤º
        const distanceItem = document.getElementById('distance-item');
        const distanceValue = document.getElementById('distance-value');
        if (checkpoint.distance !== null && checkpoint.distance !== undefined) {
          const distanceKm = (checkpoint.distance * 111).toFixed(2); // è½‰æ›ç‚ºå…¬é‡Œï¼ˆç²—ç•¥ï¼‰
          distanceValue.textContent = `${distanceKm} km`;
          distanceItem.style.display = 'flex';
        } else {
          distanceItem.style.display = 'none';
        }
        
        // è¨­å®šæ“æ“ ç¨‹åº¦å’Œé¡è‰²
        const levelText = getLevelText(checkpoint.comparison_ratio);
        const levelColor = getDynamicColor(checkpoint.comparison_ratio);
        
        document.getElementById('crowd-level').textContent = levelText;
        document.getElementById('crowd-level').style.background = levelColor + '40'; // 40% é€æ˜åº¦
        document.getElementById('crowd-level').style.color = levelColor;
        
        // è¨­å®šæŒ‡ç¤ºå™¨é¡è‰²
        const indicator = document.getElementById('crowd-indicator');
        indicator.style.color = levelColor;
        indicator.style.background = levelColor;
        
        // è¨˜éŒ„ç•¶å‰é¡¯ç¤ºçš„åœ°é»
        currentShowingLocation = checkpoint.name;
        
        // é¡¯ç¤ºè³‡è¨Šå¡
        infoCard.classList.add('show');
        
        console.log('ğŸ“‹ é¡¯ç¤ºåœ°é»è³‡è¨Š:', checkpoint.name);
      }
      
      function hideLocationInfo() {
        infoCard.classList.remove('show');
        currentShowingLocation = null;
        console.log('ğŸ“‹ éš±è—åœ°é»è³‡è¨Š');
      }
      
      function updateCurrentLocationInfo() {
        // å¦‚æœæœ‰åœ°é»æ­£åœ¨é¡¯ç¤ºï¼Œæ›´æ–°å…¶è³‡è¨Š
        if (currentShowingLocation && crowdData.length > 0) {
          const checkpoint = crowdData.find(item => item.name === currentShowingLocation);
          if (checkpoint) {
            console.log('ğŸ”„ æ›´æ–°è³‡è¨Šå¡å…§å®¹:', currentShowingLocation);
            showLocationInfo(checkpoint);
          }
        }
      }
      
      // é—œé–‰æŒ‰éˆ•äº‹ä»¶
      infoCardClose.addEventListener('click', hideLocationInfo);
      
      // é»æ“Šå¡ç‰‡å¤–éƒ¨éš±è—
      document.addEventListener('click', function(e) {
        if (!infoCard.contains(e.target) && !e.target.closest('.custom-marker')) {
          hideLocationInfo();
        }
      });

      // æ™‚é–“è»¸ç›¸é—œå‡½æ•¸
      function indexToTime(index) {
        // å°‡ 0-47 çš„ç´¢å¼•è½‰æ›ç‚º 00:00 åˆ° 23:30 çš„æ™‚é–“
        const hours = Math.floor(index / 2);
        const minutes = (index % 2) * 30;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      }

      function timeToIndex(timeStr) {
        // å°‡ HH:MM æ™‚é–“è½‰æ›ç‚º 0-47 çš„ç´¢å¼•
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 2 + (minutes >= 30 ? 1 : 0);
      }

      function getCurrentTimeIndex() {
        // ç²å–ç•¶å‰æ™‚é–“å°æ‡‰çš„ç´¢å¼•
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        return hours * 2 + (minutes >= 30 ? 1 : 0);
      }

      function updateTimeDisplay(side, index) {
        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        const timeStr = indexToTime(index);
        document.getElementById(`time-display-${side}`).textContent = timeStr;
      }

      function getQueryTime() {
        // æ ¹æ“šç•¶å‰åç§»é‡è¨ˆç®—æŸ¥è©¢æ™‚é–“
        const currentIndex = getCurrentTimeIndex();
        const targetIndex = Math.max(0, Math.min(47, currentIndex + currentTimeOffset));
        return indexToTime(targetIndex);
      }

      async function loadCheckpoints(queryTime = null) {
        try {
          // æ§‹å»º API URLï¼Œå¦‚æœæœ‰ç”¨æˆ¶ä½ç½®å°±åŠ ä¸Šåƒæ•¸
          let apiUrl = '/api/checkpoints';
          const params = new URLSearchParams();
          
          if (currentLat !== null && currentLon !== null) {
            params.append('lat', currentLat);
            params.append('lon', currentLon);
            console.log(`ä½¿ç”¨ç”¨æˆ¶ä½ç½® (${currentLat}, ${currentLon}) ç¯©é¸æœ€è¿‘çš„åœ°é»`);
          } else {
            console.log('æ²’æœ‰ç”¨æˆ¶ä½ç½®ï¼Œé¡¯ç¤ºæ‰€æœ‰åœ°é»');
          }
          
          // æ·»åŠ æ™‚é–“åƒæ•¸
          if (queryTime) {
            params.append('time', queryTime);
            console.log(`æŸ¥è©¢æ™‚é–“: ${queryTime}`);
          }
          
          if (params.toString()) {
            apiUrl += '?' + params.toString();
          }
          
          console.log('ğŸ” APIè«‹æ±‚:', apiUrl);
          const res = await fetch(apiUrl);
          
          if (!res.ok) {
            throw new Error(`APIéŒ¯èª¤: ${res.status} ${res.statusText}`);
          }
          
          const responseText = await res.text();
          console.log('ğŸ“¥ APIéŸ¿æ‡‰é•·åº¦:', responseText.length);
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (jsonError) {
            console.error('JSONè§£æéŒ¯èª¤:', jsonError);
            console.error('éŸ¿æ‡‰å…§å®¹:', responseText.substring(0, 500));
            throw new Error('æœå‹™å™¨è¿”å›ç„¡æ•ˆçš„JSONæ•¸æ“š');
          }
          
          if (data.error) {
            throw new Error(`æœå‹™å™¨éŒ¯èª¤: ${data.error}`);
          }
          
          crowdData = data;
          console.log(`âœ… è¼‰å…¥äº† ${crowdData.length} å€‹åœ°é»`);
          
          // æ¸…é™¤ç¾æœ‰æ¨™è¨˜ä¸¦é‡æ–°æ·»åŠ 
          map.markers.clear();
          
          // é‡æ–°æ·»åŠ ç”¨æˆ¶æ¨™è¨˜ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          if (currentLat !== null && currentLon !== null) {
            const userPin = new atlas.HtmlMarker({
              color: 'blue',
              text: 'U',
              position: [currentLon, currentLat]
            });
            map.markers.add(userPin);
          }
          
          // å¾Œç«¯å·²ç¶“è¨ˆç®—å¥½ levelï¼Œç›´æ¥ä½¿ç”¨
          addCheckpointsToMap();
          
          // å¦‚æœè³‡è¨Šå¡æ­£åœ¨é¡¯ç¤ºï¼Œæ›´æ–°å…¶å…§å®¹
          updateCurrentLocationInfo();
          
        } catch (error) {
          console.error('âŒ loadCheckpointséŒ¯èª¤:', error);
          // ç”¨æˆ¶å‹å–„çš„éŒ¯èª¤æç¤º
          if (map && map.getCanvas) {
            // å¯ä»¥åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºéŒ¯èª¤æç¤º
            console.warn('åœ°é»è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
          }
        }
      }

      function addCheckpointsToMap() {
        crowdData.forEach((checkpoint) => {
          // é˜²è­·æª¢æŸ¥ï¼šç¢ºä¿ level å­˜åœ¨ä¸”æœ‰å€¼
          const level = checkpoint.level || 'unknown';
          const avgCount = checkpoint.avg_count || checkpoint.person_count || 0;
          const dataCount = checkpoint.data_count || 0;
          
          // å‹•æ…‹é¡è‰²è¨ˆç®—
          let markerColor;
          if (level === 'dynamic' && checkpoint.comparison_ratio !== undefined) {
            markerColor = getDynamicColor(checkpoint.comparison_ratio);
          } else {
            markerColor = crowdColor[level] || 'gray';
          }
          
          const popup = new atlas.Popup({
            content: `<div style="padding:8px">
              <b>${checkpoint.name}</b><br>
              ç•¶å‰å¹³å‡ï¼š<span style="color:${markerColor};font-weight:bold">${avgCount}äºº</span><br>
              æ•´é«”å¹³å‡ï¼š${checkpoint.overall_avg || 'N/A'}äºº<br>
              å°æ¯”å€¼ï¼š<span style="color:${markerColor};font-weight:bold">${checkpoint.comparison_ratio || 'N/A'}</span><br>
              è³‡æ–™ç­†æ•¸ï¼š${dataCount}ç­†<br>
              æ“æ“ ç¨‹åº¦ï¼š<span style="color:${markerColor};font-weight:bold">${getLevelText(checkpoint.comparison_ratio)}</span>
            </div>`
          });

          // å‰µå»ºè‡ªå®šç¾©çš„æ¶²æ…‹ç»ç’ƒé¢¨æ ¼åœ–æ¨™
          const customMarker = document.createElement('div');
          customMarker.className = 'custom-marker';
          customMarker.innerHTML = `
            <div class="marker-glass" style="
              background: rgba(255,255,255,0.25);
              backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px);
              border-radius: 16px;
              border: 1px solid rgba(255,255,255,0.18);
              padding: 8px 12px;
              box-shadow: 0 4px 16px rgba(31,38,135,0.3);
              display: flex;
              align-items: center;
              gap: 8px;
              min-width: 80px;
              max-width: 120px;
              transition: all 0.2s ease;
            ">
              <div class="marker-dot" style="
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: ${markerColor};
                box-shadow: 0 0 8px ${markerColor};
                flex-shrink: 0;
              "></div>
              <div class="marker-text" style="
                color: #222;
                font-size: 12px;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(255,255,255,0.3);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              ">${checkpoint.name}</div>
            </div>
          `;

          // æ·»åŠ æ‡¸åœæ•ˆæœ
          customMarker.addEventListener('mouseenter', function() {
            this.querySelector('.marker-glass').style.transform = 'scale(1.05)';
            this.querySelector('.marker-glass').style.boxShadow = '0 6px 20px rgba(31,38,135,0.4)';
          });
          
          customMarker.addEventListener('mouseleave', function() {
            this.querySelector('.marker-glass').style.transform = 'scale(1)';
            this.querySelector('.marker-glass').style.boxShadow = '0 4px 16px rgba(31,38,135,0.3)';
          });

          // å‰µå»º Azure Maps æ¨™è¨˜
          const pin = new atlas.HtmlMarker({
            htmlContent: customMarker,
            position: [checkpoint.lon, checkpoint.lat],
            anchor: 'center'
          });

          map.markers.add(pin);
          
          // ç¶å®šé»æ“Šäº‹ä»¶
          setTimeout(() => {
            pin.getElement().addEventListener('click', (e) => {
              e.stopPropagation();
              
              // ç§»é™¤å½ˆå‡ºçª—å£ï¼Œä½¿ç”¨è³‡è¨Šå¡æ›¿ä»£
              // popup.open(map, pin.getOptions().position);
              
              // å°‡åœ°åœ–ä¸­å¿ƒç§»å‹•åˆ°é»æ“Šçš„åœ°é»
              map.setCamera({ 
                center: [checkpoint.lon, checkpoint.lat], 
                zoom: 18,
                duration: 800 // å¹³æ»‘å‹•ç•«
              });
              
              // é¡¯ç¤ºè³‡è¨Šå¡
              showLocationInfo(checkpoint);
            });
          }, 0);
        });
      }

      const crowdColor = {
        very_low: 'darkgreen',
        low: 'green',
        mid: 'orange',
        high: 'red',
        unknown: 'gray'
      };

      map.events.add('ready', function () {
        // å…ˆè¼‰å…¥åœ°é»è³‡æ–™ï¼ˆæ²’æœ‰ä½ç½®ç¯©é¸ï¼‰
        loadCheckpoints();
        
        // å˜—è©¦ç²å¾—ä½¿ç”¨è€…å³æ™‚ä½ç½®
        if (navigator.geolocation) {
          console.log('ğŸ” å˜—è©¦ç²å–ç”¨æˆ¶ä½ç½®...');
          
          navigator.geolocation.getCurrentPosition(
            function (position) {
              // æˆåŠŸç²å–ä½ç½®
              console.log('âœ… æˆåŠŸç²å–å¯¦éš›ä½ç½®');
              currentLat = position.coords.latitude;
              currentLon = position.coords.longitude;
              
              // è‡¨æ™‚ä½¿ç”¨æ—¥æœ¬ä½ç½®é€²è¡Œæ¸¬è©¦
              currentLat = 35.6329;
              currentLon = 139.88056;
              
              console.log(`ğŸ“ ç”¨æˆ¶ä½ç½®è¨­å®šç‚º: (${currentLat}, ${currentLon})`);
              map.setCamera({ center: [currentLon, currentLat], zoom: 18 });

              const userPopup = new atlas.Popup({
                content: `<div style="padding:5px"><b>ä½ åœ¨é€™è£¡</b></div>`
              });
              const userPin = new atlas.HtmlMarker({
                color: 'blue',
                text: 'U',
                position: [currentLon, currentLat]
              });
              map.markers.add(userPin);
              
              setTimeout(() => {
                userPin.getElement().addEventListener('click', (e) => {
                  e.stopPropagation();
                  userPopup.open(map, userPin.getOptions().position);
                  map.setCamera({ center: [currentLon, currentLat], zoom: 19 });
                });
              }, 0);
              
              // ä½ç½®è¨­å®šå®Œæˆå¾Œï¼Œé‡æ–°è¼‰å…¥åœ°é»è³‡æ–™ï¼ˆä½¿ç”¨è·é›¢ç¯©é¸ï¼‰
              console.log('ğŸ”„ ç”¨æˆ¶ä½ç½®å·²è¨­å®šï¼Œé‡æ–°è¼‰å…¥æœ€è¿‘çš„åœ°é»');
              // æ¸…é™¤ç¾æœ‰çš„åœ°åœ–æ¨™è¨˜
              map.markers.clear();
              // é‡æ–°æ·»åŠ ç”¨æˆ¶æ¨™è¨˜
              map.markers.add(userPin);
              // é‡æ–°è¼‰å…¥åœ°é»è³‡æ–™
              loadCheckpoints();
            },
            function (error) {
              // ä½ç½®ç²å–å¤±æ•—çš„è™•ç†
              console.warn('âš ï¸ ä½ç½®ç²å–å¤±æ•—:', error);
              console.warn('éŒ¯èª¤ä»£ç¢¼:', error.code);
              console.warn('éŒ¯èª¤è¨Šæ¯:', error.message);
              
              // æä¾›å‚™ç”¨ä½ç½®ï¼ˆé è¨­å°åŒ—ï¼‰
              currentLat = 25.034;
              currentLon = 121.5654;
              console.log(`ğŸ“ ä½¿ç”¨å‚™ç”¨ä½ç½®: (${currentLat}, ${currentLon})`);
              
              map.setCamera({ center: [currentLon, currentLat], zoom: 15 });
              
              // é¡¯ç¤ºå‚™ç”¨ä½ç½®æ¨™è¨˜
              const fallbackPin = new atlas.HtmlMarker({
                color: 'orange',
                text: '?',
                position: [currentLon, currentLat]
              });
              map.markers.add(fallbackPin);
              
              // é‡æ–°è¼‰å…¥åœ°é»è³‡æ–™
              loadCheckpoints();
            },
            {
              // ä½ç½®ç²å–é¸é …
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000
            }
          );
        } else {
          console.warn('âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®æœå‹™');
          // ç€è¦½å™¨ä¸æ”¯æ´ä½ç½®æœå‹™æ™‚çš„å‚™ç”¨è™•ç†
          currentLat = 25.034;
          currentLon = 121.5654;
          map.setCamera({ center: [currentLon, currentLat], zoom: 15 });
          loadCheckpoints();
        }
      });

      function getCurrentTimeString() {
        const now = new Date();
        return now.toTimeString().slice(0,5); // ä¾‹å¦‚ "14:00"
      }

      const chatHistory = document.getElementById('chat-history');

      // çŸ­æœŸè¨˜æ†¶åŠŸèƒ½ - localStorage å°è©±æ­·å²ç®¡ç†
      const CHAT_STORAGE_KEY = 'crowdRadarChatHistory';
      const MAX_CHAT_MESSAGES = 50; // é™åˆ¶æœ€å¤§è¨Šæ¯æ•¸é‡ä»¥é¿å…localStorageéå¤§

      // æª¢æ¸¬ localStorage å¯ç”¨æ€§
      function isLocalStorageAvailable() {
        try {
          const test = '__localStorage_test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }

      const hasLocalStorage = isLocalStorageAvailable();
      if (!hasLocalStorage) {
        console.warn('âš ï¸ localStorage ä¸å¯ç”¨ï¼Œå°è©±æ­·å²åŠŸèƒ½å·²åœç”¨');
      }

      function saveChatHistory() {
        if (!hasLocalStorage) return; // localStorage ä¸å¯ç”¨æ™‚ç›´æ¥è¿”å›
        
        try {
          const messages = Array.from(chatHistory.children).map(msg => ({
            role: msg.classList.contains('user') ? 'user' : 'ai',
            content: msg.classList.contains('user') ? msg.textContent : msg.innerHTML,
            timestamp: Date.now()
          }));
          
          // åªä¿ç•™æœ€æ–°çš„è¨Šæ¯
          const limitedMessages = messages.slice(-MAX_CHAT_MESSAGES);
          localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(limitedMessages));
          
          // æ›´æ–°æ¨™é¡Œé¡¯ç¤ºè¨Šæ¯æ•¸é‡ï¼ˆå¯é¸çš„è¦–è¦ºå›é¥‹ï¼‰
          if (limitedMessages.length > 0) {
            console.log(`ğŸ’¾ å·²ä¿å­˜ ${limitedMessages.length} æ¢å°è©±è¨˜éŒ„`);
          }
        } catch (error) {
          console.warn('ç„¡æ³•ä¿å­˜å°è©±æ­·å²:', error);
        }
      }

      function loadChatHistory() {
        if (!hasLocalStorage) return; // localStorage ä¸å¯ç”¨æ™‚ç›´æ¥è¿”å›
        
        try {
          const savedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
          if (savedHistory) {
            const messages = JSON.parse(savedHistory);
            
            // æ¸…ç©ºç¾æœ‰å°è©±
            chatHistory.innerHTML = '';
            
            // æ¢å¾©å°è©±è¨˜éŒ„
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message ' + msg.role;
              
              if (msg.role === 'ai') {
                div.innerHTML = msg.content; // AIè¨Šæ¯æ”¯æ´HTML/Markdown
              } else {
                div.textContent = msg.content; // ç”¨æˆ¶è¨Šæ¯ç´”æ–‡å­—
              }
              
              chatHistory.appendChild(div);
            });
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            console.log(`ğŸ”„ æ¢å¾©äº† ${messages.length} æ¢å°è©±è¨˜éŒ„`);
          }
        } catch (error) {
          console.warn('ç„¡æ³•è¼‰å…¥å°è©±æ­·å²:', error);
          // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œæ¸…é™¤æå£çš„æ•¸æ“š
          if (hasLocalStorage) {
            localStorage.removeItem(CHAT_STORAGE_KEY);
          }
        }
      }

      function clearChatHistory() {
        if (hasLocalStorage) {
          localStorage.removeItem(CHAT_STORAGE_KEY);
        }
        chatHistory.innerHTML = '';
        console.log('ğŸ—‘ å°è©±æ­·å²å·²æ¸…é™¤');
      }

      function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = 'message ' + (role === 'user' ? 'user' : 'ai');
        if (role === 'ai') {
          div.innerHTML = marked.parse(text); // æ”¯æ´ markdown
        } else {
          div.innerText = text;
        }
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        // æ¯æ¬¡æ·»åŠ è¨Šæ¯å¾Œä¿å­˜åˆ°localStorage
        saveChatHistory();
      }

      function getChatContext() {
        // ç²å–å°è©±ä¸Šä¸‹æ–‡ï¼Œç”¨æ–¼ç™¼é€çµ¦ AI
        if (!hasLocalStorage) return [];
        
        try {
          const savedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
          if (savedHistory) {
            const messages = JSON.parse(savedHistory);
            
            // éæ¿¾æ‰ç³»çµ±è¨Šæ¯ï¼ˆå¦‚æ¸…é™¤æ­·å²çš„æç¤ºï¼‰
            const validMessages = messages.filter(msg => 
              !msg.content.includes('å°è©±æ­·å²å·²æ¸…é™¤') && 
              !msg.content.includes('AI æ­£åœ¨æ€è€ƒä¸­') &&
              !msg.content.includes('âœ¨') &&
              msg.content.trim().length > 0
            );
            
            // å¢åŠ ä¸Šä¸‹æ–‡é•·åº¦ï¼Œå–æœ€è¿‘çš„ 12 æ¢å°è©±ï¼ˆ6çµ„å°è©±ï¼‰
            const recentMessages = validMessages.slice(-12).map(msg => ({
              role: msg.role === 'user' ? 'user' : 'assistant',
              content: msg.role === 'user' ? 
                msg.content : 
                msg.content.replace(/<[^>]*>/g, '').replace(/\n+/g, ' ').trim() // æ¸…ç† HTML å’Œå¤šé¤˜ç©ºè¡Œ
            }));
            
            console.log(`ğŸ“ æº–å‚™ç™¼é€ ${recentMessages.length} æ¢å°è©±ä½œç‚ºä¸Šä¸‹æ–‡`);
            console.log('ä¸Šä¸‹æ–‡å…§å®¹é è¦½:', recentMessages.slice(-4)); // é¡¯ç¤ºæœ€è¿‘4æ¢
            return recentMessages;
          }
        } catch (error) {
          console.warn('ç„¡æ³•ç²å–å°è©±ä¸Šä¸‹æ–‡:', error);
        }
        
        return [];
      }

      document.getElementById('ask-btn').addEventListener('click', async () => {
        const allLocations = crowdData.map(cp => cp.name); // ä¾‹å¦‚ ["Ké¤¨", "ç¦åˆ©ç¤¾", ...]
        const prompt = document.getElementById('prompt-input').value.trim();
        const customPrompt = localStorage.getItem('customPrompt') || '';

        // é˜²æ­¢ç™¼é€ç©ºè¨Šæ¯
        if (!prompt) {
          return;
        }

        // ç²å–å°è©±æ­·å²ä½œç‚ºä¸Šä¸‹æ–‡
        const chatContext = getChatContext();

        appendMessage('user', prompt);
        document.getElementById('prompt-input').value = '';
        appendMessage('ai', 'AI æ­£åœ¨æ€è€ƒä¸­...');
        console.log('ğŸ“¤ ç™¼é€çš„ç”¨æˆ¶è¨Šæ¯:', prompt);
        console.log('ğŸ“š ç™¼é€çš„å°è©±ä¸Šä¸‹æ–‡:', chatContext);
        console.log('ğŸ”¢ ä¸Šä¸‹æ–‡æ¢æ•¸:', chatContext.length);
        
        try {
          const response = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt,
              locations: allLocations,
              current_location: { lat: currentLat, lon: currentLon },
              current_time: getCurrentTimeString(),
              custom_prompt: customPrompt,
              chat_history: chatContext // æ–°å¢ï¼šå‚³é€å°è©±æ­·å²
            })
          });
          const data = await response.json();

          // ç§»é™¤ã€ŒAI æ­£åœ¨æ€è€ƒä¸­...ã€
          const lastMsg = chatHistory.querySelector('.message.ai:last-child');
          if (lastMsg && lastMsg.innerText === 'AI æ­£åœ¨æ€è€ƒä¸­...') {
            lastMsg.remove();
          }
          appendMessage('ai', data.reply || 'AI æ²’æœ‰å›æ‡‰');
        } catch (error) {
          console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
          // ç§»é™¤ã€ŒAI æ­£åœ¨æ€è€ƒä¸­...ã€
          const lastMsg = chatHistory.querySelector('.message.ai:last-child');
          if (lastMsg && lastMsg.innerText === 'AI æ­£åœ¨æ€è€ƒä¸­...') {
            lastMsg.remove();
          }
          appendMessage('ai', 'è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
        
        // ç¢ºä¿è¼¸å…¥æ¡†é‡æ–°ç²å¾—ç„¦é»
        setTimeout(() => {
          promptInput.focus();
        }, 100);
      });

      // ç•«é›·é”åœ–
      function drawRadar() {
        const canvas = document.getElementById('radar-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,60,60);
        // å¤–åœˆ
        ctx.globalAlpha = 0.18;
        ctx.beginPath();
        ctx.arc(30,30,28,0,2*Math.PI);
        ctx.fillStyle = '#222';
        ctx.fill();
        // å…§åœˆ
        ctx.globalAlpha = 0.35;
        ctx.beginPath();
        ctx.arc(30,30,18,0,2*Math.PI);
        ctx.fillStyle = '#888';
        ctx.fill();
        // ä¸­å¿ƒ
        ctx.globalAlpha = 0.7;
        ctx.beginPath();
        ctx.arc(30,30,7,0,2*Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        // é›·é”ç·š
        ctx.globalAlpha = 0.7;
        ctx.strokeStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(30,30);
        ctx.lineTo(30,5);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(30,30);
        ctx.lineTo(55,30);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }
      drawRadar();

      // é–‹é—œèŠå¤©å®¤
      const radarFab = document.getElementById('radar-fab');
      const glassPanel = document.getElementById('glass-panel');
      const closePanel = document.getElementById('close-panel');
      const clearChatBtn = document.getElementById('clear-chat');

      radarFab.addEventListener('click', () => {
        glassPanel.classList.add('open');
        radarFab.style.display = 'none';
      });
      closePanel.addEventListener('click', () => {
        glassPanel.classList.remove('open');
        setTimeout(() => { radarFab.style.display = 'flex'; }, 400);
      });

      clearChatBtn.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±æ­·å²å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          clearChatHistory();
          appendMessage('ai', 'âœ¨ å°è©±æ­·å²å·²æ¸…é™¤ï¼Œæˆ‘å€‘é‡æ–°é–‹å§‹å§ï¼');
        }
      });

      // è¨­å®šåŠŸèƒ½
      const settingsPanel = document.getElementById('settings-panel');
      const settingsModal = document.getElementById('settings-modal');
      const saveSettings = document.getElementById('save-settings');
      const cancelSettings = document.getElementById('cancel-settings');
      const customPromptInput = document.getElementById('custom-prompt');

      // è¼‰å…¥å·²å„²å­˜çš„è¨­å®š
      const savedCustomPrompt = localStorage.getItem('customPrompt') || '';
      customPromptInput.value = savedCustomPrompt;

      settingsPanel.addEventListener('click', () => {
        settingsModal.classList.add('open');
      });

      cancelSettings.addEventListener('click', () => {
        settingsModal.classList.remove('open');
        customPromptInput.value = savedCustomPrompt; // æ¢å¾©åŸå€¼
      });

      saveSettings.addEventListener('click', () => {
        const customPrompt = customPromptInput.value.trim();
        localStorage.setItem('customPrompt', customPrompt);
        settingsModal.classList.remove('open');
        
        // é¡¯ç¤ºå„²å­˜æˆåŠŸè¨Šæ¯
        const tempMsg = document.createElement('div');
        tempMsg.textContent = 'è¨­å®šå·²å„²å­˜';
        tempMsg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,120,212,0.9);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 100;
          font-size: 14px;
        `;
        document.body.appendChild(tempMsg);
        setTimeout(() => tempMsg.remove(), 2000);
      });

      // é»æ“ŠèƒŒæ™¯é—œé–‰è¨­å®š
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('open');
          customPromptInput.value = savedCustomPrompt; // æ¢å¾©åŸå€¼
        }
      });

      // Enter é€å‡ºè¨Šæ¯
      const promptInput = document.getElementById('prompt-input');
      promptInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          // æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹
          const inputValue = this.value.trim();
          console.log('EnteréµæŒ‰ä¸‹ï¼Œè¼¸å…¥å…§å®¹:', inputValue);
          
          if (inputValue) {
            // è§¸ç™¼ç™¼é€è¨Šæ¯æŒ‰éˆ•
            document.getElementById('ask-btn').click();
            console.log('âœ… è¨Šæ¯å·²ç™¼é€ï¼Œè¼¸å…¥æ¡†æ‡‰å·²æ¸…ç©º');
          } else {
            console.log('âš ï¸ è¼¸å…¥æ¡†ç‚ºç©ºï¼Œä¸ç™¼é€è¨Šæ¯');
          }
          
          // ç¢ºä¿è¼¸å…¥æ¡†ä¿æŒç„¦é»
          setTimeout(() => {
            this.focus();
            console.log('ğŸ¯ è¼¸å…¥æ¡†é‡æ–°ç²å¾—ç„¦é»');
          }, 100);
        }
      });

      // ç¢ºä¿è¼¸å…¥æ¡†åœ¨ç™¼é€å¾Œé‡æ–°ç²å¾—ç„¦é»
      // document.getElementById('ask-btn').addEventListener('click', function() {
      //   setTimeout(() => {
      //     promptInput.focus();
      //   }, 100);
      // });

      // ç¦ç”¨åœ°åœ–ç¸®æ”¾ï¼ˆå‡è¨­ map è®Šæ•¸å¯ç”¨ï¼‰
      promptInput.addEventListener('focus', function() {
        console.log('ğŸ“ è¼¸å…¥æ¡†ç²å¾—ç„¦é»');
        if (map && map.controls) {
          map.controls.remove('zoom');
        }
        // æ‰‹æ©Ÿè‡ªå‹•å½ˆå‡ºéµç›¤
        setTimeout(() => promptInput.scrollIntoView({behavior: 'smooth', block: 'center'}), 100);
      });
      promptInput.addEventListener('blur', function() {
        console.log('ğŸ“ è¼¸å…¥æ¡†å¤±å»ç„¦é»');
        // æ¢å¾©åœ°åœ–ç¸®æ”¾
        // map.controls.add('zoom'); // æ ¹æ“šä½ çš„åœ°åœ–APIèª¿æ•´
      });

      // åˆå§‹åŒ–æ™‚é–“è»¸æ§åˆ¶å™¨
      function initTimeControls() {
        const leftSlider = document.getElementById('time-slider-left');
        const rightSlider = document.getElementById('time-slider-right');
        const currentIndex = getCurrentTimeIndex();
        
        // è¨­ç½®åˆå§‹å€¼
        leftSlider.value = 47; // å·¦å´æ»‘æ¡¿åˆå§‹ä½æ–¼æœ€å³é‚Šï¼ˆç¾åœ¨æ™‚é–“ï¼‰
        rightSlider.value = 0; // å³å´æ»‘æ¡¿åˆå§‹ä½æ–¼æœ€å·¦é‚Š
        updateTimeDisplay('left', currentIndex);
        updateTimeDisplay('right', currentIndex);
        
        // å·¦å´æ»‘æ¡¿ï¼ˆå¾€å‰ï¼‰- å¾å³(47)å¾€å·¦(0)æ»‘å‹•æŸ¥çœ‹éå»
        leftSlider.addEventListener('input', function(e) {
          const value = parseInt(e.target.value);
          // å€¼è¶Šå°ï¼Œæ™‚é–“è¶Šå¾€å‰
          const stepsBack = 47 - value; // å¾å³é‚Š(47)é–‹å§‹ï¼Œå¾€å·¦æ»‘å‹•
          currentTimeOffset = -stepsBack;
          
          // è¨ˆç®—ä¸¦é¡¯ç¤ºå¯¦éš›æ™‚é–“
          const targetIndex = Math.max(0, currentIndex + currentTimeOffset);
          updateTimeDisplay('left', targetIndex);
          
          // é‡ç½®å³å´æ»‘æ¡¿
          rightSlider.value = 0;
          updateTimeDisplay('right', currentIndex);
          
          // åªæœ‰ç•¶æ™‚é–“åç§»ä¸ç‚º0æ™‚æ‰æ›´æ–°åœ°åœ–è³‡æ–™
          if (currentTimeOffset !== 0) {
            const queryTime = getQueryTime();
            loadCheckpoints(queryTime);
          } else {
            loadCheckpoints(); // å›åˆ°ç•¶å‰æ™‚é–“ï¼Œä¸å‚³éæ™‚é–“åƒæ•¸
          }
        });
        
        // å³å´æ»‘æ¡¿ï¼ˆå¾€å¾Œï¼‰- å¾å·¦(0)å¾€å³(47)æ»‘å‹•æŸ¥çœ‹æœªä¾†
        rightSlider.addEventListener('input', function(e) {
          const value = parseInt(e.target.value);
          currentTimeOffset = value; // å·¦åˆ°å³æ»‘å‹•è¡¨ç¤ºå¾€å¾Œ
          
          // è¨ˆç®—ä¸¦é¡¯ç¤ºå¯¦éš›æ™‚é–“
          const targetIndex = Math.min(47, currentIndex + value);
          updateTimeDisplay('right', targetIndex);
          
          // é‡ç½®å·¦å´æ»‘æ¡¿åˆ°åˆå§‹ä½ç½®ï¼ˆæœ€å³é‚Šï¼‰
          leftSlider.value = 47;
          updateTimeDisplay('left', currentIndex);
          
          // åªæœ‰ç•¶æ™‚é–“åç§»ä¸ç‚º0æ™‚æ‰æ›´æ–°åœ°åœ–è³‡æ–™
          if (currentTimeOffset !== 0) {
            const queryTime = getQueryTime();
            loadCheckpoints(queryTime);
          } else {
            loadCheckpoints(); // å›åˆ°ç•¶å‰æ™‚é–“ï¼Œä¸å‚³éæ™‚é–“åƒæ•¸
          }
        });
        
        console.log('æ™‚é–“è»¸æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
        console.log(`ç•¶å‰æ™‚é–“ç´¢å¼•: ${currentIndex} (${indexToTime(currentIndex)})`);
      }
      
      // åœ¨åœ°åœ–æº–å‚™å¥½å¾Œåˆå§‹åŒ–æ™‚é–“æ§åˆ¶å™¨
      setTimeout(() => {
        initTimeControls();
        loadChatHistory(); // åˆå§‹åŒ–æ™‚åŠ è¼‰å°è©±æ­·å²
      }, 1000);

      // å‹•æ…‹é¡è‰²è¨ˆç®—å‡½æ•¸
      function getDynamicColor(ratio) {
        // ratio ç¯„åœï¼š-1 åˆ° 1
        // -1: æ·±ç¶ è‰²ï¼ˆå¾ˆç©ºï¼‰
        // 0: é»ƒè‰²ï¼ˆæ­£å¸¸ï¼‰
        // 1: æ·±ç´…è‰²ï¼ˆå¾ˆæ“æ“ ï¼‰
        
        if (ratio <= -0.5) {
          // æ·±ç¶ è‰²åˆ°ç¶ è‰²
          const intensity = Math.abs(ratio + 0.5) * 2; // 0 åˆ° 1
          return `rgb(0, ${100 + Math.floor(intensity * 155)}, 0)`;
        } else if (ratio <= 0) {
          // ç¶ è‰²åˆ°é»ƒè‰²
          const intensity = (ratio + 0.5) * 2; // 0 åˆ° 1
          return `rgb(${Math.floor(intensity * 255)}, ${255 - Math.floor(intensity * 100)}, 0)`;
        } else if (ratio <= 0.5) {
          // é»ƒè‰²åˆ°æ©™è‰²
          const intensity = ratio * 2; // 0 åˆ° 1
          return `rgb(255, ${255 - Math.floor(intensity * 165)}, 0)`;
        } else {
          // æ©™è‰²åˆ°æ·±ç´…è‰²
          const intensity = (ratio - 0.5) * 2; // 0 åˆ° 1
          return `rgb(255, ${90 - Math.floor(intensity * 90)}, 0)`;
        }
      }

      // æ ¹æ“šå°æ¯”å€¼å–å¾—ç­‰ç´šæ–‡å­—
      function getLevelText(ratio) {
        if (ratio === undefined || ratio === null) return 'UNKNOWN';
        
        if (ratio <= -0.3) return 'VERY LOW';
        if (ratio <= -0.1) return 'LOW';
        if (ratio <= 0.1) return 'NORMAL';
        if (ratio <= 0.3) return 'HIGH';
        return 'VERY HIGH';
      }
    }
  </script>
</body>
</html>